<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PIO: NetCDF API Integration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PIO
   &#160;<span id="projectnumber">2.5.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">NetCDF API Integration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The netCDF integration feature allows existing netCDF codes, in C or Fortran, to be easily converted to use PIO.</p>
<h1><a class="anchor" id="autotoc_md35"></a>
Building and Using PIO with NetCDF Integration</h1>
<p>In order to use netCDF integration:</p>
<p>The PIO configure must use the option &ndash;enable-netcdf-integration.</p>
<p>Version 4.7.2 or later of the netCDF C library.</p>
<p>Once PIO is build for netCDF integration, it provides the nc_* and nf_* functions required to fully integrate PIO and netCDF. Users must include the PIO header files in their C or Fortran programs, and link to the PIO and the netCDF libraries (and, optionally, the parallel-netcdf and HDF5 libraries).</p>
<h1><a class="anchor" id="autotoc_md36"></a>
Initializing the IO System</h1>
<p>IO system initialization is required before anyother PIO functionality is used in netCDF calls. The IO system defines how many processors are used for I/O, and how many for computation.</p>
<p>The IO system may be initialized in one of two modes:</p>
<p>Intercomm Mode - All processors are involved in computation. A subset does I/O (and also computation). To initialize in intercomm mode, use <a class="el" href="pio_8h.html#af6cf8ae0c4e537b2def1ad21939eacdb" title="Same as PIOc_Init_Intracomm().">nc_def_iosystem()</a>.</p>
<p>Async Mode - Some processors are dedicated to IO, and do no computation. Other processors are organized into computational unit. Each computational unit runs its own code. All computational units which do netCDF/PIO calls will channel all IO through the dedicated I/O nodes. To initialize in async mode, use <a class="el" href="pio_8h.html#a6bbc705121bd1c5908897f0928918b2c" title="Same as PIOc_init_async().">nc_def_async()</a>.</p>
<p>Once defined, these functions return one or (in the case of async) more IO system IDs, usually abreviated in the code as 'iosysid'.</p>
<p>For intercomm mode, there is one iosysid. For async mode, there is an array of iosysids, one for each computational unit.</p>
<h1><a class="anchor" id="autotoc_md37"></a>
The Default IO System</h1>
<p>The IO system ID (iosysid) must be provided for PIO calls. When using netCDF integration, there is no parameter in the functions available to pass the iosysid. Instead, there is a default iosysid. When creating a new IO system, the default iosysid is set, so that subsequent netCDF calls can know which IO system to use.</p>
<p>In the (rare) cases where the user may wish to use multiple IO systems within the same section of code, the functions <a class="el" href="pio_8h.html#a4685a0a9e74456d2d35d9455e6c9a25f" title="Set the default iosystemID.">nc_set_iosystem()</a> and <a class="el" href="pio_8h.html#aeb9fd5e32645513e833bb4ff8e3d4ea8" title="Get the default iosystemID.">nc_get_iosystem()</a> will allow the user to set and get the defauly iosysid.</p>
<h1><a class="anchor" id="autotoc_md38"></a>
Opening/Creating a File</h1>
<p>To open a file, use nc_open()/nf_open(), providing the NC_PIO flag.</p>
<p>In C:</p>
<div class="fragment"><div class="line"><span class="comment">/* Initialize the intracomm. */</span></div>
<div class="line"><span class="keywordflow">if</span> (nc_def_iosystemm(MPI_COMM_WORLD, 1, 1, 0, 0, &amp;iosysid)) PERR;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Create a file with a 3D record var. */</span></div>
<div class="line"><span class="keywordflow">if</span> (nc_create(FILE_NAME, <a class="code" href="pio_8h.html#aa74b956293ed1430514e598213040894">NC_PIO</a>, &amp;ncid)) PERR;</div>
<div class="line"><span class="keywordflow">if</span> (nc_def_dim(ncid, DIM_NAME_UNLIMITED, dimlen[0], &amp;dimid[0])) PERR;</div>
<div class="line"><span class="keywordflow">if</span> (nc_def_dim(ncid, DIM_NAME_X, dimlen[1], &amp;dimid[1])) PERR;</div>
<div class="line"><span class="keywordflow">if</span> (nc_def_dim(ncid, DIM_NAME_Y, dimlen[2], &amp;dimid[2])) PERR;</div>
<div class="line"><span class="keywordflow">if</span> (nc_def_var(ncid, <a class="code" href="example1_8c.html#a73de0b1772c59096554d6a846feff376">VAR_NAME</a>, NC_INT, NDIM3, dimid, &amp;varid)) PERR;</div>
</div><!-- fragment --><p>Resources associated with the IO system must be released with <a class="el" href="pio_8h.html#a718b1ec15da7584ba90448c2f46a2d41" title="Same as PIOc_free_iosystem().">nc_free_iosystem()</a>/nf_free_iosystem().</p>
<p>In Fortran:</p>
<div class="fragment"><div class="line"><span class="comment">! Define an IOSystem.</span></div>
<div class="line">ierr = nf_def_iosystem(my_rank, mpi_comm_world, niotasks, numaggregator, &amp;</div>
<div class="line">     stride, pio_rearr_box, iosysid, base)</div>
<div class="line"><span class="keywordflow">if</span> (ierr .ne. nf_noerr) <span class="keyword">call </span>handle_err(ierr)</div>
<div class="line"> </div>
<div class="line"><span class="comment">! Create a file.</span></div>
<div class="line">ierr = nf_create(file_name, 64, ncid)</div>
<div class="line"><span class="keywordflow">if</span> (ierr .ne. nf_noerr) <span class="keyword">call </span>handle_err(ierr)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md39"></a>
Defining a Decomposition</h1>
<p>To define a decompositon for a distributed array use <a class="el" href="pio_8h.html#a7910bfa348afa49807077cca4ee1a70b" title="Same as PIOc_init_decomp().">nc_def_decomp()</a>/nf_def_decomp().</p>
<p>In C: </p><div class="fragment"><div class="line"><span class="comment">/* Calculate a decomposition for distributed arrays. */</span></div>
<div class="line">elements_per_pe = DIM_LEN_X * DIM_LEN_Y / ntasks;</div>
<div class="line"><span class="keywordflow">if</span> (!(compdof = malloc(elements_per_pe * <span class="keyword">sizeof</span>(<span class="keywordtype">size_t</span>))))</div>
<div class="line">    PERR;</div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; elements_per_pe; i++)</div>
<div class="line">    compdof[i] = my_rank * elements_per_pe + i;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Create the PIO decomposition for this test. */</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="pio_8h.html#a7910bfa348afa49807077cca4ee1a70b">nc_def_decomp</a>(iosysid, <a class="code" href="pio_8h.html#a8a87ab3b37b8b4bed50ec29b699f3bfd">PIO_INT</a>, NDIM2, &amp;dimlen[1], elements_per_pe,</div>
<div class="line">                  compdof, &amp;<a class="code" href="structwmulti__buffer.html#a667fee0c4b8abf44a2b0703e097ab5f6">ioid</a>, 1, NULL, NULL)) PERR;</div>
<div class="line">free(compdof);</div>
</div><!-- fragment --><p>In Fortran: </p><div class="fragment"><div class="line"><span class="keyword">allocate</span>(compdof(maplen))</div>
<div class="line"><span class="keyword">allocate</span>(data_buffer(maplen))</div>
<div class="line"><span class="comment">! Row decomposition. Recall that my_rank is 0-based, even</span></div>
<div class="line"><span class="comment">! in fortran. Also recall that compdof is 1-based for fortran.</span></div>
<div class="line"><span class="keywordflow">do</span> i = 1, maplen</div>
<div class="line">   compdof(i) = i + my_rank * maplen</div>
<div class="line">   data_buffer(i) = my_rank * 10 + i</div>
<div class="line"><span class="keywordflow">end do</span></div>
<div class="line">print *, <span class="stringliteral">&#39;compdof&#39;</span>, my_rank, compdof</div>
<div class="line">ierr = nf_def_decomp(iosysid, pio_int, dims, compdof, decompid)</div>
<div class="line"><span class="keywordflow">if</span> (ierr .ne. nf_noerr) <span class="keyword">call </span>handle_err(ierr)</div>
</div><!-- fragment --><p>When a decomposition is defined, a decomposition ID is returned, and must be used later when accessing data using this decomposition.</p>
<p>The resources associated with a decomposition must be freed with <a class="el" href="pio_8h.html#aacd75c9219f563f9ea560303423b8ab9" title="Same as PIOc_freedecomp().">nc_free_decomp()</a>/nf_free_decomp().</p>
<h1><a class="anchor" id="autotoc_md40"></a>
Reading and Writing Distributed Arrays</h1>
<p>Once a decomposition has been defined, it may be used to read and write distributed arrays. This allows the code to be written in terms of local storage only. That is, the array allocated and indexed in the code is the array of data that this processor works with. When the data is read/written, the library will map the local data into the global array space.</p>
<p>To read distributed data, use the <a class="el" href="group___p_i_o__read__darray__c.html#ga0204f98868594ae83ff39f0078ed3e5a" title="Get a muti-dimensional subset of a variable the same type as the variable in the file.">nc_get_vard()</a> function, or one of the type-specific versions (ex. <a class="el" href="group___p_i_o__read__darray__c.html#gab2e4b38ce7f213195e27862706180ec6" title="Get a muti-dimensional subset of an integer variable.">nc_get_vard_int()</a>).</p>
<p>To write distributed data, use the <a class="el" href="group___p_i_o__write__darray__c.html#ga1c2e8bd99a65b7122d3569bea16f1045" title="Write distributed array subset of a variable of any type.">nc_put_vard()</a> function, or one of the type-specific versions (ex. <a class="el" href="group___p_i_o__write__darray__c.html#gac213d1c1cc5fee1599578e8f06e9d475" title="Put distributed array subset of an integer variable.">nc_put_vard_int()</a>).</p>
<p>In C: </p><div class="fragment"><div class="line"><span class="comment">/* Write some data with distributed arrays. */</span></div>
<div class="line"><span class="keywordflow">if</span> (<a class="code" href="group___p_i_o__write__darray__c.html#gac213d1c1cc5fee1599578e8f06e9d475">nc_put_vard_int</a>(ncid, varid, <a class="code" href="structwmulti__buffer.html#a667fee0c4b8abf44a2b0703e097ab5f6">ioid</a>, 0, my_data)) PERR;</div>
<div class="line"><span class="keywordflow">if</span> (nc_close(ncid)) PERR;</div>
</div><!-- fragment --><p>In Fortran: </p><div class="fragment"><div class="line"><span class="comment">! Write 1st record with distributed arrays.</span></div>
<div class="line">ierr = nf_put_vard_int(ncid, varid, decompid, 1, data_buffer)</div>
<div class="line"><span class="keywordflow">if</span> (ierr .ne. nf_noerr) <span class="keyword">call </span>handle_err(ierr)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md41"></a>
Examples in C and Fortran</h1>
<p>For examples using the netCDF integration features, look in the tests/ncint directory (for C) or the tests/fncint directory (for Fortran). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="agroup___p_i_o__write__darray__c_html_gac213d1c1cc5fee1599578e8f06e9d475"><div class="ttname"><a href="group___p_i_o__write__darray__c.html#gac213d1c1cc5fee1599578e8f06e9d475">nc_put_vard_int</a></div><div class="ttdeci">int nc_put_vard_int(int ncid, int varid, int decompid, const size_t recnum, const int *op)</div><div class="ttdoc">Put distributed array subset of an integer variable.</div><div class="ttdef"><b>Definition:</b> nc_put_vard.c:162</div></div>
<div class="ttc" id="aexample1_8c_html_a73de0b1772c59096554d6a846feff376"><div class="ttname"><a href="example1_8c.html#a73de0b1772c59096554d6a846feff376">VAR_NAME</a></div><div class="ttdeci">#define VAR_NAME</div><div class="ttdoc">The name of the variable in the netCDF output file.</div><div class="ttdef"><b>Definition:</b> example1.c:48</div></div>
<div class="ttc" id="astructwmulti__buffer_html_a667fee0c4b8abf44a2b0703e097ab5f6"><div class="ttname"><a href="structwmulti__buffer.html#a667fee0c4b8abf44a2b0703e097ab5f6">wmulti_buffer::ioid</a></div><div class="ttdeci">int ioid</div><div class="ttdoc">The ID that describes the decomposition, as returned from PIOc_Init_Decomp().</div><div class="ttdef"><b>Definition:</b> pio.h:507</div></div>
<div class="ttc" id="apio_8h_html_a7910bfa348afa49807077cca4ee1a70b"><div class="ttname"><a href="pio_8h.html#a7910bfa348afa49807077cca4ee1a70b">nc_def_decomp</a></div><div class="ttdeci">int nc_def_decomp(int iosysid, int pio_type, int ndims, const int *gdimlen, int maplen, const size_t *compmap, int *ioidp, int rearranger, const size_t *iostart, const size_t *iocount)</div><div class="ttdoc">Same as PIOc_init_decomp().</div><div class="ttdef"><b>Definition:</b> ncint_pio.c:158</div></div>
<div class="ttc" id="apio_8h_html_aa74b956293ed1430514e598213040894"><div class="ttname"><a href="pio_8h.html#aa74b956293ed1430514e598213040894">NC_PIO</a></div><div class="ttdeci">#define NC_PIO</div><div class="ttdoc">A convience macro for netCDF integration code.</div><div class="ttdef"><b>Definition:</b> pio.h:98</div></div>
<div class="ttc" id="apio_8h_html_a8a87ab3b37b8b4bed50ec29b699f3bfd"><div class="ttname"><a href="pio_8h.html#a8a87ab3b37b8b4bed50ec29b699f3bfd">PIO_INT</a></div><div class="ttdeci">#define PIO_INT</div><div class="ttdoc">signed 4 byte integer</div><div class="ttdef"><b>Definition:</b> pio.h:649</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Mar 2 2021 10:44:51 for PIO by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>

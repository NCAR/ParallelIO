name: Build with Spack
# Tests ParallelIO using Intel Compiler and IMPI library.
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Installs
      run: |
        set -x
        sudo apt-get update 
        sudo apt-get install wget
        sudo apt-get install libjpeg-dev
        sudo apt-get install libz-dev
        sudo apt-get install gfortran

    - name: cache spack
      id: cache-spack
      uses: actions/cache@v3
      with:
        path: |
          ~/work/ParallelIO/ParallelIO/spack
          ~/.spack
        key: spack-${{ runner.os }}
    - name: Get Spack
      if: steps.cache-spack.outputs.cache-hit != 'true'
      uses: actions/checkout@v3
      with:
        repository: spack/spack
        path: spack
        ref: v0.19.0
    - name: Prep spack
      run: |
        source $GITHUB_WORKSPACE/spack/share/spack/setup-env.sh
        spack compiler find
        # add a line for this SHA to the parallelio package so that this commit is available
        if grep -Fxq "githubtest"  $GITHUB_WORKSPACE/spack/var/spack/repos/builtin/packages/parallelio/package.py
        then
          #sed -i 's/version("githubtest", commit=.*$/version("githubtest", sha256="$GITHUB_SHA")/' \
          cat $GITHUB_WORKSPACE/spack/var/spack/repos/builtin/packages/parallelio/package.py 
        else
          sed -i 's/maintainers = \["jedwards4b"\]/maintainers = ["jedwards4b"]\n    version("githubtest", commit="$GITHUB_SHA")/' \
          $GITHUB_WORKSPACE/spack/var/spack/repos/builtin/packages/parallelio/package.py
        fi
        cat $GITHUB_WORKSPACE/spack/var/spack/repos/builtin/packages/parallelio/package.py  
        spack install parallelio@githubtest
